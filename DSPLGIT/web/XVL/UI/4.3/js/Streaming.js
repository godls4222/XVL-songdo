"use strict";void 0===Int8Array.prototype.forEach&&[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array].forEach(function(e){void 0===e.prototype.forEach&&(e.prototype.forEach=function(e){var t,r=this.length;for(t=0;t<r;t++)e(this[t],t,this)})}),THREE.ResourceEntry=function(){},THREE.ResourceEntry.prototype.setMeshProxy=function(e){this.meshProxy=e},THREE.ResourceEntry.prototype.getMeshProxy=function(){return this.meshProxy},THREE.ResourceArray=function(){this._entryArray=[]},THREE.ResourceArray.prototype.setEntry=function(e,t){return this._entryArray[e]=new THREE.ResourceEntry(t),this._entryArray[e]},THREE.ResourceArray.prototype.getEntry=function(e){return this._entryArray[e]},THREE.ResourceArray.prototype.clearEntry=function(){this._entryArray.length=0},THREE.Resources=function(){this.buffersArray=new THREE.ResourceArray,this.bufferViewsArray=new THREE.ResourceArray,this.materialsArray=new THREE.ResourceArray,this.meshesArray=new THREE.ResourceArray},THREE.Resources.prototype.clear=function(){this.buffersArray.clearEntry(),this.bufferViewsArray.clearEntry(),this.materialsArray.clearEntry(),this.meshesArray.clearEntry()},THREE.NodeProxy=function(e){this.temporaryMesh=null,this.meshProxies=[],this.threeMeshes={},this.threeNode=e,this.modelLODtype=THREE.LODTYPE_16},THREE.NodeProxy.prototype.add=function(e){if(-1!==this.meshProxies.indexOf(e))return void alert("THREE.NodeProxy.add -> already added object.");this.meshProxies.push(e),this.threeMeshes[e.id]=[],e.parents.push(this),e.bufferView.bufferHD&&e.bufferView.bufferHD&&(this.modelLODtype=THREE.LODTYPE_2),e.bufferView.bufferHD&&e.bufferView.bufferHD&&(e.modelLODtype=THREE.LODTYPE_2)},THREE.NodeProxy.prototype.remove=function(e){var t=this.meshProxies.indexOf(e);if(-1===t)return void alert("THREE.NodeProxy.remove -> already added object.");var e=this.meshProxies[t];if(delete this.threeMeshes[e.id],this.meshProxies.splice(t,1),-1===(t=e.parents.indexof(this)))return void alert("THREE.NodeProxy.remove -> invalid parent-child relation ship.");e.parents.splice(t,1),e.postRemove()},THREE.NodeProxy.prototype.build=function(e,t){var r=e.meshes,i=e.extras;if(!Array.isArray(r))return void alert("THREE.NodeProxy: nodeDescription.meshe is not Array.");var o,a=r.length,s=new THREE.Box3,n=void 0,l=THREE.resources;this.meshProxies=[];var d=!1;for(o=0;o<a;o++){var u,_=l.meshesArray.getEntry(r[o]),L=_.boundingBox;0!==_.primitives.length&&(s.expandByPoint(new THREE.Vector3(L.max[0],L.max[1],L.max[2])),s.expandByPoint(new THREE.Vector3(L.min[0],L.min[1],L.min[2])),_.bufferView.geomRange&&(d=!0),u=_.getMeshProxy(),u||(u=new THREE.MeshProxy,_.setMeshProxy(u),u.build(_),void 0===n&&u.primitiveMaterials&&u.primitiveMaterials.length>0&&(n=u.primitiveMaterials[0]),i&&i.edgeType&&u.primitiveModes.forEach(function(e,r,o){if(e>>THREE.PRIM_MODE_BIT==1){var a=this.primitiveMaterials[r],s=THREE.getLineMaterial(i,a.name,a.color);s&&(this.primitiveMaterials[r]=s,t.materials.push(s))}},u)),this.add(u))}if(d){var h=t.bufferViewProxies.getEntry("bufferView_Geom");h&&(this.geomBufferViewProxy=h)}if(!s.isEmpty()){var m,c=new THREE.Matrix4,v=s.size(),f=s.center(),E=new THREE.Quaternion;0===v.x&&(v.x=1e-4),0===v.y&&(v.y=1e-4),0===v.z&&(v.z=1e-4),v.multiplyScalar(1.05),c.compose(f,E,v);var p=THREE.streamManager.getCurrentStream();p||concole.log("No current stream."),m=new p._temporaryObjectType(p.getTemporaryGeometry(),n),m.isSmartLoadingProxyShape=!0,m.matrixAutoUpdate=!1,m.applyMatrix(c),this.temporaryMesh=m,this.boundingBox=s}},THREE.NodeProxy.prototype.removeTemporaryMesh=function(){this.threeNode.remove(this.temporaryMesh)},THREE.NodeProxy.prototype.addTemporaryMesh=function(){this.threeNode.add(this.temporaryMesh)},THREE.NodeProxy.prototype.dispose=function(){this.temporaryMesh=null;var e=this;this.meshProxies.froEach(function(t){e.remove(t)}),this.meshProxies=[],this.object.nodeProxy=null,this.object=null},THREE.MeshProxyIdCount=0,THREE.MeshProxy=function(){this.id=THREE.MeshProxyIdCount++,this.parents=[],this.primitiveModes=[],this.intIndices=[],this.primitiveMaterials=[],this.primitiveGeometries=[],this.primitiveRanges=[],this.bufferView=null,this.loadedLODLevel=-1,this.loadedLODType=void 0,this.modelLODtype=THREE.LODTYPE_16},THREE.PRIM_TRIANGLE=4,THREE.PRIM_LINES=1,THREE.PRIM_NRM_MASK=4,THREE.PRIM_UV_MASK=2,THREE.PRIM_COLOR_MASK=1,THREE.PRIM_MODE_BIT=3,THREE.RANGE_LODTYPE_LD=1,THREE.RANGE_LODTYPE_HD=2,THREE.LODTYPE_16=0,THREE.LODTYPE_2=1,THREE.OUTFLAG_UNKNOWN=0,THREE.OUTFLAG_INSIDE=1,THREE.OUTFLAG_OUTLINE=2,THREE.OUTFLAG_SHIFT_BIT=4,THREE.OUTFLAG_MASK=15,THREE.MeshProxy.prototype.build=function(e){var t,r=e.primitives.length;for(t=0;t<r;t++){var i=e.primitives[t].mode,o=e.primitives[t].uv,a=e.primitives[t].color,s=e.primitives[t].intIdx,n=e.primitives[t].noNrm?0:1;o=o||0,a=a||0,s=!!s,this.primitiveModes[t]=(i<<THREE.PRIM_MODE_BIT)+(n<<2)+(o<<1)+a,this.intIndices[t]=s,this.primitiveMaterials[t]=e.primitives[t].material,this.primitiveGeometries[t]=null}this.bufferView=e.bufferView,this.boundingBox=e.boundingBox,e.boundingBoxUV&&(this.boundingBoxUV=e.boundingBoxUV),void 0!==e.outline&&(this.outline=e.outline),void 0!==e.partColor&&(this.partColor=e.partColor),void 0!==e.userData&&(this.userData=e.userData)},THREE.MeshProxy.prototype.dispose=function(){this.parents.length=0,this.primitiveModes.length=0,this.intIndices.length=0,this.primitiveMaterials.length=0,this.primitiveGeometries.length=0,this.primitiveRanges.forEach(function(e){for(var t in e)e[t]=null}),this.primitiveRanges.length=0,this.bufferView=null},THREE.MeshProxy.prototype.postRemove=function(){1===this.parents.length&&this.dispose()},THREE.MeshProxy.prototype.isSegmentRange=function(){var e=this.bufferView;return!!(e.segIdxRange||e.segRange||e.geomRange)},THREE.Stream=function(){Object.defineProperties(this,{_loader:{value:null,writable:!0},_enableProcess:{value:!0,writable:!0},_xhrBatchSize:{value:10,writable:!0},_xhrProcessMaxSize:{value:100,writable:!0},_maxWorkerCount:{value:1,writable:!0},_workers:{value:[],writable:!0},_viewer:{value:null,writable:!0},_LODLevels:{value:{LODTYPE_16:null,LODTYPE_2:null},writable:!0},_decodeFactors:{value:{LODTYPE_16:null,LODTYPE_2:null},writable:!0},_temporaryGeometry:{value:null,writable:!0},_instanceMaxLODLevels:{value:{},writable:!0},_updateMeshRequests:{value:{},writable:!0},_updateLODLevelTable:{value:[],writable:!0},_updateLODLevelTableForceLoad:{value:[],writable:!0},_isNeedUpdateBoundingBox:{value:{smart:!1,force:!1},writable:!0},_isNeedUpdateAttribute:{value:!1,writable:!0},_workerRequests:{value:{},writable:!0},_forceLoadRequests:{value:{},writable:!0},_isForceLoadComplete:{value:!0,writable:!0},_isNeedUpdateAssociatedHighlight:{value:!1,writable:!0},_isNeedUpdateSelectionBoundingBox:{value:!1,writable:!0},_updateTemporaryMeshSelected:{value:{},writable:!0},_geomInfoRequests:{value:0,writable:!0},_geomInfoLoaded:{value:0,writable:!0},_pendingLoadGeomInfos:{value:[],writable:!0},_requestedGeomInfoCount:{value:0,writable:!0},_buildedGeomInfoCount:{value:0,writable:!0},_workerRequestsBuildModel:{value:{smart:{requestCount:0,execedCount:0},force:{requestCount:0,execedCount:0}},writable:!0},_workerRequestsCount:{value:0,writable:!0},_workerRequestsLoadedCount:{value:0,writable:!0},_totalReceiveDataSize:{value:0,writable:!0},_isFirstSmartLoadRequest:{value:!1,writable:!0},_isFirstForceLoadRequest:{value:!1,writable:!0},_viewFrustumLODLevelRate:{value:10/15,writable:!0},_BUFFER_PARAMETER:{enumerable:!1,value:{position:{typedArray:Uint16Array,BYTES_PER_ELEMENT:2,componentSize:3},normal:{typedArray:Uint8Array,BYTES_PER_ELEMENT:1,componentSize:2},uv:{typedArray:Uint16Array,BYTES_PER_ELEMENT:2,componentSize:2},color:{typedArray:Uint8Array,BYTES_PER_ELEMENT:1,componentSize:3},lineDistance:{typedArray:Float32Array,BYTES_PER_ELEMENT:4,componentSize:1},index:{typedArray:Uint16Array,BYTES_PER_ELEMENT:2,componentSize:1},index_32:{typedArray:Uint32Array,BYTES_PER_ELEMENT:4,componentSize:1}},writable:!1},_TIME_INTERVAL:{enumerable:!1,value:600},_LOAD_TIME_INTERVAL:{enumerable:!1,value:5,writable:!0},_EXEC_LOAD_COUNT:{enumerable:!1,value:1e3,writable:!0},_STATUS:{enumerable:!1,value:{NONE:"NONE",BUILDING_REQUESTS:"BUILDING_REQUESTS",PROCESSING_REQUESTS:"PROCESSING_REQUESTS"},writable:!1},_streamingStatus:{enumerable:!0,value:"NONE",writable:!0},_OUTLINE_LOAD_MODE:{enumerable:!1,value:{OUTLINE:"outline",INSIDE:"inside"},writable:!1},_outlineUnknownLoadMode:{enumerable:!0,value:"inside",writable:!0},_timeoutID:{enumerable:!0,value:void 0,writable:!0},_cameraMatrixWorld:{enumerable:!0,value:null,writable:!0},_zoom:{enumerable:!0,value:null,writable:!0},_execFrameEnd:{enumerable:!0,value:!1,writable:!0},_camera:{enumerable:!0,value:null,writable:!0},_projScreenMatrix:{enumerable:!0,value:null,writable:!0},_delayGenGeomTable:{value:[],writable:!0},_MEASURE_LOADING_TIME:{value:!1,writable:!0},_measureTimeInfo:{enumerable:!0,value:{_enabled:!1,_div:null,_timeStart:0,init:function(){this._enabled=!1;var e=document.getElementById("center");if(e){var t=document.createElement("div");e.appendChild(t),this._div=t,this._enabled=!0}},start:function(){this._enabled&&(this._timeStart=Date.now(),this._div.innerHTML="Load start...("+lt.BROWSER+")")},end:function(e){if(this._enabled&&0===Object.keys(e).length){var t=Date.now()-this._timeStart;this._div.innerHTML="Load end... "+t/1e3+"sec ("+lt.BROWSER+")"}}},writable:!0},_viewRefreshManager:{enumerable:!0,value:{_enable:!1,_INTERVAL:void 0,_initTime:void 0,init:function(e){"gecko"===lt.BROWSER?(this._INTERVAL=600,this._enable=!0):lt.BROWSER.match(/IE11/)?(this._INTERVAL=1e3,this._enable=!0):this._enable=!1},clear:function(){this._initTime=Date.now()},isRefresh:function(e){return!this._enable||(void 0===this._initTime||Date.now()-this._initTime>this._INTERVAL||0===Object.keys(e).length)}},writable:!0},frameBegin:{enumerable:!1,value:function(e,t,r){if(this._viewer&&t.name!==lt.VIEWING_CAMERA_NAME_SELECTION_VIEW&&(THREE.streamManager.setCurrentStream(this),this._enableProcess)){this._camera=t,this._projScreenMatrix=r,this._startSmartLoading=!1;var i=void 0;if(this._viewer.deviceOrientationControls&&(i=.01),!0===e||null===this._cameraMatrixWorld||!this._cameraMatrixWorld.equals(t.matrixWorld,i)||t instanceof THREE.OrthographicCamera&&this._zoom!==t.zoom){if(!0!==e&&(this._isNeedUpdateBoundingBox.smart||this._isNeedUpdateBoundingBox.force)&&(this._isNeedUpdateBoundingBox.smart=!1,this._isNeedUpdateBoundingBox.force=!1,this._viewer.model.updateBoundingBox(!1),this._viewer.setBoundingBoxCube(!0),this._viewer.needsRender=!0),this._viewer._forceLoadType===lt.FORCE_LOAD_PROFILE&&Object.keys(this._forceLoadRequests).length>0)return;if(this._stopSmartLoading)return;if(this._updateLODLevelTable.length>0)return;if(this._updateLODLevelTableForceLoad.length>0)return;if(Object.keys(this._workerRequests).length>0)return;if(this._viewer.model.eventPlayer._animObjLoadStatus===this._viewer.model.eventPlayer._forceLoadState.LOAD&&null!==this._viewer.model.eventPlayer._loadTargetAnimation)return;this._startSmartLoading=!0,this._cameraMatrixWorld||(this._cameraMatrixWorld=new THREE.Matrix4),void 0!==this._loadTimeoutID&&(clearTimeout(this._loadTimeoutID),this._loadTimeoutID=void 0),void 0!==this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=void 0),this._streamingStatus!==this._STATUS.NONE&&(this._streamingStatus=this._STATUS.NONE,this.clearUpdateMeshRequests())}}}},frameEnd:{enumerabe:!1,value:function(e){if(this._viewer&&e.name!==lt.VIEWING_CAMERA_NAME_SELECTION_VIEW&&(THREE.streamManager.setCurrentStream(null),this._enableProcess))if(this._cameraMatrixWorld.copy(e.matrixWorld),e instanceof THREE.OrthographicCamera&&(this._zoom=e.zoom),this._startSmartLoading){var t=this;this._timeoutID=setTimeout(function(){t._viewer.model.eventPlayer._animObjLoadStatus===t._viewer.model.eventPlayer._forceLoadState.LOAD&&null!==t._viewer.model.eventPlayer._loadTargetAnimation||(t._viewer.loadWholeModel||(t._stopSmartLoading||t._smartLoadStart||0!==Object.keys(t._workerRequests).length||0!==t._updateLODLevelTable.length||(t._smartLoadStart=!0,t._isFirstSmartLoadRequest=!0,t._viewer.dispatchEvent({type:"smartLoadStart"})),t._isForceLoad()&&(t._viewer._forceLoadType!==lt.FORCE_LOAD_ALL&&t._viewer._forceLoadType!==lt.FORCE_LOAD_PROFILE&&t._viewer._forceLoadType!==lt.FORCE_LOAD_GROUP||!t._viewer._isForceLoadGroupsComplete)&&!t._forceLoadStart&&0===Object.keys(t._forceLoadRequests).length&&0===t._updateLODLevelTableForceLoad.length&&t._isForceLoadComplete&&(t._forceLoadStart=!0,t._isForceLoadComplete=!1,t._isFirstForceLoadRequest=!0,t._viewer.dispatchEvent({type:"forceLoadStart"}))),t._streamingStatus=t._STATUS.BUILDING_REQUESTS,t.invalidateViewer())},this._TIME_INTERVAL)}else this._streamingStatus===this._STATUS.BUILDING_REQUESTS&&(this._streamingStatus=this._STATUS.PROCESSING_REQUESTS,this.executeProcess())}},executeProcess:{enumerable:!1,value:function(){!0!==this._stopSmartLoading&&this._streamingStatus===this._STATUS.PROCESSING_REQUESTS&&(this.clearInstanceMaxLODLevels(),this.postMessage({type:"process"}))}},invalidateViewer:{enumerable:!1,value:function(e){this._viewer&&(this._viewer.needsRender=!0,e&&(this._viewer.model.scene.needsUpdate=!0))}},initialize:{enumerable:!1,value:function(e,t){function r(e){var t=e.data,r=t.id,i=l._workerRequests[r];if(void 0===i)return void console.log("onload -> workerRequest not registererd.");delete l._workerRequests[r],l.isAllExecutionRequestsCompleted()&&(l._workerRequestsCount=0,l._workerRequestsLoadedCount=0),i.request.delayGenGeom?l._delayGenGeomTable.push({request:i,response:t}):l._generateGeometry(t,i),i.request.forceLoadRequest?l._workerRequestsBuildModel.force.execedCount++:l._workerRequestsBuildModel.smart.execedCount++,l.updateModelProgress()}function i(e){l.processRequests()}function o(e){var t=e.data;if(void 0!==t.id){var r=t.id,i=l._workerRequests[r];if(void 0===i)return void console.log("onabort -> workerRequest not registererd.");delete l._workerRequests[r],l.isAllExecutionRequestsCompleted()&&(l._workerRequestsCount=0,l._workerRequestsLoadedCount=0);var o=i.meshProxy.id;l._forceLoadRequests[o]&&delete l._forceLoadRequests[o]}l._delayGenGeomTable.length>0&&(l._delayGenGeomTable.length=0),l._handlecallback(!0),l._handleForceLoadCallback(!0)}function a(e){var t=e.data,r=t.id,i=l._workerRequests[r];if(void 0===i)return void console.log("onerror -> workerRequest not registererd.");delete l._workerRequests[r],l.isAllExecutionRequestsCompleted()&&(l._workerRequestsCount=0,l._workerRequestsLoadedCount=0);var o=i.meshProxy.id;if(l._forceLoadRequests[o]&&delete l._forceLoadRequests[o],l._viewer&&l._viewer._loadErrorCallback){var a={};switch(t.status){case 408:a.errorType="timeOut";break;default:a.errorType="http"}a.url=t.uri,a.httpStatus=t.status;var r=i.meshProxy.parents[0].threeNode.name,s='Load failed id "'+r+'". '+t.text;a.message=s,a.stack=new Error("").stack,a.loadType="smartLoad",l._viewer._loadErrorCallback(a)}i.request.forceLoadMaxLOD?l._workerRequestsBuildModel.force.execedCount++:l._workerRequestsBuildModel.smart.execedCount++,l.updateModelProgress(),l._handlecallback(),l._handleForceLoadCallback()}if(this._workerType=e.smartLoadingWorkerType,this._xhrProcessMaxSize=e.smartLoadingXHRProcessMaxSize,this._workerType!==lt.SL_WORKER_TYPE_SINGLEWORKER||0==this._workers.length){this._MEASURE_LOADING_TIME&&this._measureTimeInfo.init(),lt.iOS||lt.Android?(this._LODParameters.smartLoadingLODSizeMin=e.smartLoadingLODSizeMinMobile,this._LODParameters.smartLoadingLODSizeMax=e.smartLoadingLODSizeMaxMobile,this._xhrBatchSize=e.smartLoadingLoadBatchSizeMobile):(this._LODParameters.smartLoadingLODSizeMin=e.smartLoadingLODSizeMin,this._LODParameters.smartLoadingLODSizeMax=e.smartLoadingLODSizeMax,this._xhrBatchSize=e.smartLoadingLoadBatchSize),this._viewRefreshManager.init(),this._LODParameters.interpolateType=e.smartLoadingLODInterpolateType,this._LOAD_TIME_INTERVAL=e.smartLoadingLoadTimeInterval,this._EXEC_LOAD_COUNT=e.smartLoadingExecLoadCount,e.forceLoadLODLevelViewFrustum&&this.setViewFrustumLODLevelRate(e.forceLoadLODLevelViewFrustum),this._outlineUnknownLoadMode=e.outlineUnknownLoadMode,this._viewer=e;var s,n;s=THREE.getScriptPath("LoadWorker.js");var l=this;for(n=0;n<this._maxWorkerCount;n++){var d=new Worker(s);d.addEventListener("message",function(e){switch(e.data.type){case"onForceLoadStop":var t=e.data,s=t.id,n=l._workerRequests[s];if(void 0===n)return void console.log("onerror -> workerRequest not registererd.");delete l._workerRequests[s],l.isAllExecutionRequestsCompleted()&&(l._workerRequestsCount=0,l._workerRequestsLoadedCount=0);var d=n.meshProxy.id;l._forceLoadRequests[d]&&delete l._forceLoadRequests[d],0===Object.keys(l._forceLoadRequests).length&&(l._forceLoadStart=!1,l._isForceLoadComplete=!0,l._updateLODLevelTableForceLoad.length>0&&console.log("_updateLODLevelTableForceLoad: "+l._updateLODLevelTableForceLoad.length),l._viewer.dispatchEvent({type:"forceLoadStop"}));break;case"onBuildedLoad":var u=void 0!==e.data.requestSize?e.data.requestSize:0;l._workerRequestsLoadedCount+=u;var _=void 0!==e.data.dataSize?e.data.dataSize:0;if(l._totalReceiveDataSize+=_,l._viewer&&l._viewer._smartLoadProgressCallback){var L={};L.state="loading",L.loaded=l._workerRequestsLoadedCount,L.total=l._workerRequestsCount,l._viewer._smartLoadProgressCallback(L)}break;case"onSmartLoadRequest":l._isFirstSmartLoadRequest&&(l._isFirstSmartLoadRequest=!1,l._viewer.dispatchEvent({type:"smartLoadRequest"}));break;case"onForceLoadRequest":l._isFirstForceLoadRequest&&(l._isFirstForceLoadRequest=!1,l._viewer.dispatchEvent({type:"forceLoadRequest"}));break;case"onload":var t=e.data,s=t.id,n=l._workerRequests[s],h=!1;h=!!n.request.forceLoadRequest,r(e),h?l._isNeedUpdateBoundingBox.force=!0:l._isNeedUpdateBoundingBox.smart=!0,l._viewRefreshManager.isRefresh(l._workerRequests)&&(l.invalidateViewer(!0),l._viewRefreshManager.clear()),l._measureTimeInfo.end(l._workerRequests),l._handlecallback(),l._handleForceLoadCallback();break;case"onpreprocess":i(e);break;case"onabort":o(e);break;case"onerror":a(e);break;default:console.log("Invalid worker event === %s",e.data.type)}}),d.postMessage({type:"set worker id",value:n});var u,_,L;THREE.debugSmartLoading?(L="generic",u=0,_=!1):(L="XCM",u=this._xhrBatchSize,_="httpParameter"===e.smartLoadingMethod),d.postMessage({type:"set use http parameter",value:_}),d.postMessage({type:"set batch size",value:u}),d.postMessage({type:"set server type",value:L}),d.postMessage({type:"set worker type",value:this._workerType}),d.postMessage({type:"set request load batch max",value:this._xhrProcessMaxSize}),this._workerType===lt.SL_WORKER_TYPE_MULTIWORKER?this._workers[t]=d:this._workers[n]=d}}}},_handleForceLoadCallback:{enumerable:!1,value:function(e){if(this._forceLoadStart&&this._workerRequestsBuildModel.force.execedCount===this._workerRequestsBuildModel.force.requestCount&&(!this._viewer.geomInfo||this._geomInfoRequests===this._geomInfoLoaded)){var t=!1;if(this._viewer.loadWholeModel||this._viewer._forceLoadType!==lt.FORCE_LOAD_PROC_ANIM_OBJ?0===Object.keys(this._forceLoadRequests).length&&0===this._updateLODLevelTableForceLoad.length&&(t=!0):0===this._updateLODLevelTableForceLoad.length&&(t=!0),this._isForceLoad()&&t&&!1===this._isForceLoadComplete){switch(this._viewer._forceLoadType){case lt.FORCE_LOAD_PROFILE:this._viewer._forceLoadType=void 0}this._geomInfoRequests=0,this._geomInfoLoaded=0,this._requestedGeomInfoCount=0,this._buildedGeomInfoCount=0,this._workerRequestsBuildModel.force.requestCount=0,this._workerRequestsBuildModel.force.execedCount=0,void 0!==this._geomInfoLoadTimeoutId&&(clearTimeout(this._geomInfoLoadTimeoutId),delete this._geomInfoLoadTimeoutId),e?this._viewer.dispatchEvent({type:"forceLoadStop"}):(this._viewer._forceLoadType!==lt.FORCE_LOAD_ALL&&this._viewer._forceLoadType!==lt.FORCE_LOAD_PROFILE&&this._viewer._forceLoadType!==lt.FORCE_LOAD_GROUP||(this._viewer._isForceLoadGroupsComplete=!0),this._isNeedUpdateAttribute&&(this._isNeedUpdateAttribute=!1,this._viewer.model.handleAttribute()),this._isNeedUpdateBoundingBox.force?(this._isNeedUpdateBoundingBox.force=!1,this._viewer.model.updateBoundingBox(!1),this._viewer&&this._viewer._buildModelProgressCallback&&this._viewer._buildModelProgressCallback({Progress:90}),this._viewer.setBoundingBoxCube(!0),this._viewer.needsRender=!0,this._viewer.stateBuildModelProgress=lt.SL_BUILD_MODEL_PROGRESS_FORCE_LOADING_COMPLETE):0===Object.keys(this._forceLoadRequests).length&&0===this._updateLODLevelTableForceLoad.length&&0===this._workerRequestsBuildModel.force.requestCount&&(this._forceLoadStart=!1,this._isForceLoadComplete=!0,this._viewer.dispatchEvent({type:"forceLoadComplete"})))}}}},_handlecallback:{enumerable:!1,value:function(e){if(e)this._viewer.dispatchEvent({type:"smartLoadStop"}),this._totalReceiveDataSize=0;else{if(!this._smartLoadStart||this._workerRequestsBuildModel.smart.execedCount!==this._workerRequestsBuildModel.smart.requestCount||0!==this._updateLODLevelTable.length)return;this._isNeedUpdateAttribute&&(this._isNeedUpdateAttribute=!1,this._viewer.model.handleAttribute()),this._viewer._totalReceiveDataSize=this._totalReceiveDataSize,this._workerRequestsBuildModel.smart.requestCount=0,this._workerRequestsBuildModel.smart.execedCount=0,this._isNeedUpdateAssociatedHighlight&&(this._isNeedUpdateAssociatedHighlight=!1,this._viewer.updateAssociatedHighlight()),this._isNeedUpdateSelectionBoundingBox&&(this._isNeedUpdateSelectionBoundingBox=!1,this._viewer.cameraSelectionView&&(this._viewer.cameraSelectionView.selectedUpdate=!0),this._clearTemporaryMeshSelected()),this._isNeedUpdateBoundingBox.smart?(this._isNeedUpdateBoundingBox.smart=!1,this._viewer.model.updateBoundingBox(!1),this._viewer&&this._viewer._buildModelProgressCallback&&this._viewer._buildModelProgressCallback({Progress:90}),this._viewer.setBoundingBoxCube(!0),this._viewer.needsRender=!0,this._viewer.stateBuildModelProgress=lt.SL_BUILD_MODEL_PROGRESS_SMART_LOADING_COMPLETE):0===this._updateLODLevelTable.length&&0===this._workerRequestsBuildModel.smart.requestCount&&(this._smartLoadStart=!1,this._viewer.dispatchEvent({type:"smartLoadComplete",dataSize:this._totalReceiveDataSize})),this._totalReceiveDataSize=0}}},_generateGeometry:{enumerable:!1,value:function(e,t){var r=e.LODLevel,i=(e.LODtype,e.primitive),o=t.meshProxy,a=(t.isSegment,o.parents),s=!1;if(void 0!==e.LODtype){if(0===o.loadedLODLevel&&1===t.request.LODLevel||1===o.loadedLODLevel&&0===t.request.LODLevel)this.clearSegment(o),o.parents.forEach(function(e){var t=e.threeNode;e.threeMeshes[o.id].forEach(function(e){t.remove(e),e.geometry=null}),e.addTemporaryMesh()}),o.primitiveGeometries.forEach(function(e,t,r){null!==e&&(e.dispose(),r[t]=null,o.primitiveRanges[t].position=null,o.primitiveRanges[t].index=null)});else if(1===o.loadedLODLevel&&1===t.request.LODLevel){var n,l=i.resources.length,d=o.loadedLODLevel;for(n=0;n<l;n++)if(this._forceLoadRequests[o.id]){var u=o.primitiveGeometries[n];u&&(t&&t.request&&t.request.forceLoadMinLOD||(u._onMemoryMaxLOD=!0)),this._forceLoadRequests[o.id].primitiveCount--,0==this._forceLoadRequests[o.id].primitiveCount&&delete this._forceLoadRequests[o.id]}return void this._setSegment(o,e)}}else r<=o.loadedLODLevel&&(s=!0);if(s){console.log("onload -> LODLevel %d <= meshProxy.loadedLODLevel %d",r,o.loadedLODLevel);var n,l=i.resources.length,d=o.loadedLODLevel;for(n=0;n<l;n++)if(this._forceLoadRequests[o.id]){var u=o.primitiveGeometries[n];u&&(t&&t.request&&t.request.forceLoadMinLOD||(u._onMemoryMaxLOD=!0)),this._forceLoadRequests[o.id].primitiveCount--,0==this._forceLoadRequests[o.id].primitiveCount&&delete this._forceLoadRequests[o.id]}var _=this.getMaxLODLevel(o.modelLODtype);return void(r===o.loadedLODLevel&&r===_?(this._setSegment(o,e),t&&t.request&&t.request.forHighlightLoadMaxLOD&&(this._isNeedUpdateAssociatedHighlight=!0)):r===o.loadedLODLevel&&-1===r&&(o.isSegmentLoaded=!0))}o.loadedLODLevel!==e.loadedLODLevel&&console.log("meshProxy.loadedLODLevel= "+o.loadedLODLevel+"response.loadedLODLevel= "+e.loadedLODLevel);var L,h;L=this.getLODDecodeParam(o.boundingBox,r,o.modelLODtype),o.boundingBoxUV&&(h=this.getLODDecodeParam(o.boundingBoxUV,o.modelLODtype));var n,m=this,l=i.resources.length,d=o.loadedLODLevel;o.loadedLODType;for(n=0;n<l;n++){var c,v,u,f,E,p,O,g,R;c=e.primitive.resources[n],v=e.primitive.ranges[n],u=o.primitiveGeometries[n],f=o.primitiveModes[n],E=o.intIndices[n],p=o.primitiveMaterials[n],O=o.auxData,R=o.partColor,g=o.userData;var T=!1;u?T=!0:(u=new THREE.BufferGeometry,o.primitiveGeometries[n]=u,a.forEach(function(t){var r=null;if(f>>THREE.PRIM_MODE_BIT==4?(O&&(p=O.auxMaterial),p.polygonOffset=!0,p.polygonOffsetFactor=1,p.polygonOffsetUnits=1,r=new THREE.Mesh(u,p),O&&(r.nonReplaceTransparency=O.nonReplaceTransparency),void 0!==R&&(r.partColor=R)):f>>THREE.PRIM_MODE_BIT==1?r=new THREE.LineSegments(u,p):f>>THREE.PRIM_MODE_BIT==0?(r=new THREE.Points(u,p),r.skipDraw=!0):console.log("Ivalid primitive"),r){t.threeMeshes[o.id][n]=r,t.threeNode.add(r);var i=t.threeNode;void 0!==i.userData&&(r.userData=i.userData,void 0!==g&&"attributes"in g&&(m._isNeedUpdateAttribute=!0,r.userData.attributes=JSON.parse(JSON.stringify(g.attributes))),void 0!==t.threeNode.isClippingTarget&&(r.isClippingTarget=t.threeNode.isClippingTarget),!1===m._viewer.cutSolidSurface&&r instanceof THREE.Mesh&&(r.userData.shellType===lt.SHELL_TYPE_SOLID||r.userData.shellType===lt.SHELL_TYPE_SURFACE)&&(r.skipClipping=!0),!1===m._viewer.cutWirePoint&&r instanceof THREE.LineSegments&&r.userData.shellType===lt.SHELL_TYPE_WIRE&&(r.skipClipping=!0),lt.util.traverseGroupTypes(r,0)),o.bufferView&&(o.bufferView.geomBuffer?r.geomBufferViewProxy=o.bufferView.geomBuffer:r.geomBufferViewProxy=null)}t.temporaryMesh&&t.temporaryMesh.selected&&(m._updateTemporaryMeshSelected[t.temporaryMesh.id]=t.temporaryMesh,m._viewer.replaceSelectedObjects(t.temporaryMesh,r),r.selected=!0,r.layers.set(lt.LAYER_SEL),m._isNeedUpdateSelectionBoundingBox=!0),e.LODtype===THREE.RANGE_LODTYPE_LD||t.removeTemporaryMesh()})),this._forceLoadRequests[o.id]&&(u&&(t&&t.request&&t.request.forceLoadMinLOD||(u._onMemoryMaxLOD=!0)),0==--this._forceLoadRequests[o.id].primitiveCount&&delete this._forceLoadRequests[o.id]);for(var D in c)f>>THREE.PRIM_MODE_BIT==0&&"index"===D||function(e,t,r,i){var o,a=t[r],s=null;if(s="index"===r&&i?m._BUFFER_PARAMETER.index_32:m._BUFFER_PARAMETER[r],a&&s){if(o="index"!==r?e.getAttribute(r):e.getIndex()){var n=o.array.length+a.length,l=new s.typedArray(n);l.set(o.array,0),l.set(a,o.array.length),o.array=l,o.itemSize=s.componentSize,o.needsUpdate=!0}else o=new THREE.BufferAttribute(a,s.componentSize);"index"!==r?(e.removeAttribute(r),"position"===r?o.decodeParam=L:"uv"===r&&(o.decodeParam=h),e.addAttribute(r,o)):e.setIndex(o)}}(u,c,D,E);u.attributes&&u.attributes.position&&u.attributes.position.array.length>0&&u.boundingSphere&&0===u.boundingSphere.radius&&(delete u.boundingSphere,u.boundingSphere=null,u.computeBoundingSphere()),p instanceof THREE.LineDottedMaterial&&f>>THREE.PRIM_MODE_BIT==1&&THREE.computeLineDistance(u),T&&this.updateGeometry(u),void 0===o.primitiveRanges[n]&&(o.primitiveRanges[n]={position:[],index:[]});for(var y in o.primitiveRanges[n])if(d<0||void 0!==e.LODtype)o.primitiveRanges[n][y]=v[y];else{var b,w,M;if(b=o.primitiveRanges[n][y],M=b[b.length-1],v[y].forEach(function(e,t,r){r[t]+=M}),e.LODLevel+1<b.length)continue;if(w=new Uint32Array(e.LODLevel+1),w.set(b),w.length<v[y].length+b.length)continue;w.set(v[y],b.length),o.primitiveRanges[n][y]=w}}o.loadedLODLevel=e.LODLevel,o.loadedLODType=e.LODtype,this._setSegment(o,e),t&&t.request&&t.request.forHighlightLoadMaxLOD&&(this._isNeedUpdateAssociatedHighlight=!0)}},_setSegment:{enumerable:!1,value:function(e,t){function r(){var e;if(i._requestedGeomInfoCount===i._xhrProcessMaxSize)i._requestedGeomInfoCount===i._buildedGeomInfoCount&&(i._requestedGeomInfoCount=0,i._buildedGeomInfoCount=0);else for(;(e=i._pendingLoadGeomInfos.shift())&&(i._setGeomInfo(e.geomBufferViewProxy,e.meshProxy,e.meshGeomRange),!(++i._requestedGeomInfoCount>=i._xhrProcessMaxSize)););i._geomInfoLoadTimeoutId=setTimeout(r,10)}var i=this,o=this._viewer;if(t.isSegment&&!e.isSegmentLoaded){var a,s=(t.LODLevel,t.LODtype),n=t.primitive,l=(e.primitiveGeometries,e.parents,e.primitiveModes),d=e.bufferView.geomBuffer,u=n.resources.length,_=d?d.byteLength:0,L=_,h=-1;if(e.primitiveGeometries.forEach(function(e,t){var r,e,i,_,m,c;if(r=n.resources[t],c=l[t],(s!==THREE.RANGE_LODTYPE_LD||c>>THREE.PRIM_MODE_BIT!=1)&&c>>THREE.PRIM_MODE_BIT!=0&&e){if(i=r.seg,_=r.segIdx,m=r.geom,_){var t=e.getIndex(),v={index:{}};v.index.array=t.array,v.index.itemSize=t.itemSize,e.bufferAttributesOrg=v,t.array=_,t.needsUpdate=!0}if(i&&(e.segIndices=i),m&&(e.segGeoms=m,o.geomInfo&&d&&c>>THREE.PRIM_MODE_BIT!=0))for(a=0,u=m.length;a<u;a++){var f=m[a];-1!==f&&(L=Math.min(L,f),h=Math.max(h,f))}}}),o.geomInfo&&o._forceLoadType===lt.FORCE_LOAD_VIEW_FRUSTUM&&L<_&&h>=0&&L<=h){i._geomInfoRequests++,i.updateModelProgress();var m=[L,h],c={byteLength:d.byteLength,byteOffset:d.byteOffset,uri:d.uri};i._pendingLoadGeomInfos.push({meshProxy:e,meshGeomRange:m,geomBufferViewProxy:c}),void 0===i._geomInfoLoadTimeoutId&&(i._geomInfoLoadTimeoutId=setTimeout(r,10))}e.isSegmentLoaded=!0}}},_setGeomInfo:{enumerable:!1,value:function(e,t,r){var i=this,o=this._viewer,a=r[0];o.loadGeomInfo(e,r).then(function(r){t.primitiveGeometries.forEach(function(i,s){if(i){if(t.primitiveModes[s]>>THREE.PRIM_MODE_BIT!=0){var n=i.segGeoms;if(n){for(var l=0,d=n.length;l<d;l++){var u=n[l];if(-1!==u){var _=u+e.byteOffset-a,L=2*Uint8Array.BYTES_PER_ELEMENT+7*Float32Array.BYTES_PER_ELEMENT,h=_+L,m=r.slice(_,h);o.buildSegmentGeomInfo(i,m,l)}}i.segGeomInfos&&0===Object.keys(i.segGeomInfos).length&&delete i.segGeomInfos}}}}),i._buildedGeomInfoCount++,i._geomInfoLoaded++,i.updateModelProgress(),i._handleForceLoadCallback()}).catch(function(e){"string"==typeof e&&console.log(e),i._buildedGeomInfoCount++,i._geomInfoLoaded++,i.updateModelProgress(),i._handleForceLoadCallback()})}},_temporaryObjectType:{enumerable:!0,value:THREE.LineSegments,writable:!0},getTemporaryGeometry:{enumerable:!1,value:function(){if(this._temporaryGeometry)return this._temporaryGeometry;if(this._temporaryObjectType===THREE.Mesh)this._temporaryGeometry=new THREE.BoxBufferGeometry(1,1,1,1,1,1);else{var e=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),t=.5,r=new Float32Array([-t,-t,-t,t,-t,-t,t,t,-t,-t,t,-t,-t,-t,t,t,-t,t,t,t,t,-t,t,t]);this._temporaryGeometry=new THREE.BufferGeometry,this._temporaryGeometry.addAttribute("position",new THREE.BufferAttribute(r,3)),this._temporaryGeometry.setIndex(new THREE.BufferAttribute(e,1))}return this._temporaryGeometry}},isDrawAssociatedHighlightObject:{enumerable:!1,value:function(e){return void 0!==e.drawAssociatedHighlightElements||!(!e.parent||!e.parent.reserveLoadMaxLOD)}},isLoadMaxLODLevel:{enumerable:!1,value:function(e,t){return!(e.selected||!this.isDrawAssociatedHighlightObject(e))||(!(!t||!t.isChildPMI)||!(!e.parent||!e.parent.userData||"markup"!=e.parent.userData.auxType&&"alert"!=e.parent.userData.auxType&&"traceline"!==e.parent.userData.auxType))}},maxLODLevel:{enumerable:!1,value:function(e,t,r,i,o){var a={},s=-1,n=-1,l=e,d=this,u=e.parent.nodeProxy;u.meshProxies.forEach(function(e){var t=e.id;i[t]&&i[t].LODLevel>s&&(s=i[t].LODLevel)});for(var _=0;_<2;_++){var L,h;switch(_){case 0:n=this.sizeToLODLevel(t,o,u.modelLODtype),n>s&&(s=n),u.meshProxies.forEach(function(e){if(e.parents.length>1){var t=e.id,i=d._instanceMaxLODLevels[t];void 0!==i&&i>s?(s=i)>=0&&(r=!0):d._instanceMaxLODLevels[t]=r?s:-1}});continue;case 1:if(!this._viewer.enableSelectionView||0===this._viewer.selectedObject.length||!e.selected)continue;if(!this._viewer.elementSel)continue;var m=this._viewer.domElement.getBoundingClientRect(),c=this._viewer.elementSel.getBoundingClientRect()
;if(c.left<m.left||m.right<c.right||c.top<m.top||m.bottom<c.bottom)continue;if(r=!0,e.parent){var u=e.parent.nodeProxy;u&&(l=u.temporaryMesh)}var v=l.geometry;null===v.boundingSphere&&v.computeBoundingSphere();var f=new THREE.Sphere;f.copy(v.boundingSphere).applyMatrix4(l.matrixWorld);var h=this._viewer.renderer.getSize().height,E=f.radius,p=f.center,t=0;if(h=this._viewer.elementSel.clientHeight,(L=this._viewer.cameraSelectionView)instanceof THREE.PerspectiveCamera){var O=1/Math.tan(.5*L.fov*THREE.Math.DEG2RAD),g=L.getWorldDirection(),R=(new THREE.Vector3).subVectors(p,L.position).dot(g),T=E/R*h*O;t=T}else{var T=(L.zoom,2*E*L.zoom*h);t=T}n=this.sizeToLODLevel(t,o,u.modelLODtype)}}return n>s&&(s=n),a.LODLevel=s,a.visible=r,a}},_smartLoadStart:{enumerable:!0,value:!1,writable:!0},_forceLoadStart:{enumerable:!0,value:!1,writable:!0},_fixedLODLevel:{enumerable:!0,value:-1,writable:!0},_LODParameters:{enmerable:!0,value:{smartLoadingLODSizeMin:48,smartLoadingLODSizeMax:-66,interpolateType:0}},_workerType:{enmerable:!0,value:-1,writable:!0},getMaxLODLevel:{enumerable:!1,value:function(e){return void 0!==e&&e===THREE.LODTYPE_2?this._LODLevels.LODTYPE_2.length-1:this._LODLevels.LODTYPE_16.length-1}},sizeToLODLevel:{enumerable:!1,value:function(e,t,r){var i=this.getMaxLODLevel(r),o=this._viewer.renderer.getSize().height,a={};a.lodSizeMin=this._LODParameters.smartLoadingLODSizeMin,a.lodSizeMax=this._LODParameters.smartLoadingLODSizeMax;var s=this._LODParameters.smartLoadingLODSizeMin,n=this._LODParameters.smartLoadingLODSizeMax,l=e/o*100;if(this._viewer.getSmartLoadingLODSize(t,a),s=a.lodSizeMin,n=a.lodSizeMax,s<0?s*=-1:s=s/o*100,n<0?n*=-1:n=n/o*100,n<s||l<s)return-1;var d;d=0==this._LODParameters.interpolateType?(l-s)/(n-s):l/n;var u=Math.min(d,1);return u<0?-1:Math.floor(u*i)}},setViewFrustumLODLevelRate:{enumerable:!1,value:function(e){this._viewFrustumLODLevelRate=e/15}},getViewFrusumLODLevel:{enumerable:!1,value:function(e){var t=this.getMaxLODLevel(e.modelLODtype),r=Math.floor(this._viewFrustumLODLevelRate*t);return 1===t&&0===r&&(r=t),r}},processObject:{enumerable:!1,value:function(e,t,r,i,o,a,s){if(!0!==this._stopSmartLoading||o)if(this._streamingStatus===this._STATUS.BUILDING_REQUESTS||!0===o){var n,l=!1;if(e.parent&&e.parent.nodeProxy&&(n=e.parent.nodeProxy),e.geometry&&e.geometry._onMemoryMaxLOD)if(this._viewer.loadWholeModel&&(this._viewer.loadWholeModelElemSelect&&this._viewer.loadWholeModelElemMeasure||n&&n.meshProxies&&n.meshProxies.length>0&&n.meshProxies.forEach(function(e){!e.isSegmentLoaded&&e.isSegmentRange()&&(l=!0)})),l);else if(e.selected||!this.isDrawAssociatedHighlightObject(e))return;if(n){var d=this.getMaxLODLevel(n.modelLODtype),u=!1,_={},L=-1,h=void 0,m=this.getStreamLoadOption();if(this.isLoadMaxLODLevel(e,a)?(L=d,t=!0):(_=this.maxLODLevel(e,r,t,this._updateMeshRequests,a),L=_.LODLevel,t=_.visible),(e._forceLoadMaxLOD||this._isLoadWholeModel())&&(t=!0),m&lt.SL_OPTION_IGNORE_VIEWFRUSTUM&&s&&s.outOfFrustum&&(t=!0),e.parent&&e.parent.reserveLoadMaxLOD);else if(e._forceLoadMaxLOD||this._isLoadWholeModel()||this._viewer._forceLoadType===lt.FORCE_LOAD_VIEW_FRUSTUM){var c=!0;if(this._viewer._forceLoadType===lt.FORCE_LOAD_VIEW_FRUSTUM){var v=this.getViewFrusumLODLevel(n);L<v&&(c=!1),t&&s&&s.outOfFrustum&&(c=!1)}c&&(L=d,u=!0)}e._forceLoadMinLOD&&(h=!0,L<0&&(L=0),delete e._forceLoadMinLOD),this.requestUpdate({proxy:n,LODLevel:t?L:-1,forHighlightLoadMaxLOD:this.isDrawAssociatedHighlightObject(e),forceLoadMinLOD:h,forceLoadMaxLOD:u})}}else if(i){var f=this;e.traverse(function(e){if((e instanceof THREE.Mesh||e instanceof THREE.Line)&&e.parent&&e.parent.nodeProxy){var t=e.parent.nodeProxy;f.requestUpdate({proxy:t,LODLevel:-1,force:!0})}})}}},requestUpdate:{enumerable:!1,value:function(e){var t,r=e.LODLevel,i=e.proxy,o=this;t=i.threeNode.drawRefference?o._viewer._referenceModelOutlineLoadMode:o._viewer._outlineLoadMode,t=void 0!==t?t:lt.SL_OUTLINE_NONE,i.meshProxies.forEach(function(a){var s=a.id;if(t!==lt.SL_OUTLINE_NONE){var n=a.outline;n=void 0!==n?n:THREE.OUTFLAG_UNKNOWN;var l=lt.SL_OUTLINE_NONE,d=lt.SL_OUTLINE_NONE,u=lt.SL_OUTLINE_NONE;t&lt.SL_OUTLINE_MODEL&&(l=n,l&=THREE.OUTFLAG_MASK),t&lt.SL_OUTLINE_ID_1&&(d=n>>THREE.OUTFLAG_SHIFT_BIT,d&=THREE.OUTFLAG_MASK),t&lt.SL_OUTLINE_ID_2&&(u=n>>2*THREE.OUTFLAG_SHIFT_BIT,u&=THREE.OUTFLAG_MASK);var _=THREE.OUTFLAG_OUTLINE;switch(t){case lt.SL_OUTLINE_MODEL:_=o.getOutlineFlagFromUnknown(l);break;case lt.SL_OUTLINE_ID_1:_=o.getOutlineFlagFromUnknown(d);break;case lt.SL_OUTLINE_ID_2:_=o.getOutlineFlagFromUnknown(u);break;case lt.SL_OUTLINE_MODEL|lt.SL_OUTLINE_ID_1:l=o.getOutlineFlagFromUnknown(l),d=o.getOutlineFlagFromUnknown(d),_=l===THREE.OUTFLAG_INSIDE&&d===THREE.OUTFLAG_INSIDE?THREE.OUTFLAG_INSIDE:THREE.OUTFLAG_OUTLINE;break;case lt.SL_OUTLINE_MODEL|lt.SL_OUTLINE_ID_2:l=o.getOutlineFlagFromUnknown(l),u=o.getOutlineFlagFromUnknown(u),_=l===THREE.OUTFLAG_INSIDE&&u===THREE.OUTFLAG_INSIDE?THREE.OUTFLAG_INSIDE:THREE.OUTFLAG_OUTLINE;break;case lt.SL_OUTLINE_ID_1|lt.SL_OUTLINE_ID_2:d=o.getOutlineFlagFromUnknown(d),u=o.getOutlineFlagFromUnknown(u),_=d===THREE.OUTFLAG_INSIDE&&u===THREE.OUTFLAG_INSIDE?THREE.OUTFLAG_INSIDE:THREE.OUTFLAG_OUTLINE;break;case lt.SL_OUTLINE_MODEL|lt.SL_OUTLINE_ID_1|lt.SL_OUTLINE_ID_2:l=o.getOutlineFlagFromUnknown(l),d=o.getOutlineFlagFromUnknown(d),u=o.getOutlineFlagFromUnknown(u),_=l===THREE.OUTFLAG_INSIDE&&d===THREE.OUTFLAG_INSIDE&&u===THREE.OUTFLAG_INSIDE?THREE.OUTFLAG_INSIDE:THREE.OUTFLAG_OUTLINE}if(_===THREE.OUTFLAG_INSIDE)if(e.forceLoadMaxLOD){var L=o._viewer._outlineForceLoadMode;L=void 0!==L?L:lt.SL_OUTLINE_FORCE_ALL,L===lt.SL_OUTLINE_FORCE_OUTLINE&&(e.forceLoadMaxLOD=!1,r=-1)}else r=-1}if(!e.forceLoadMaxLOD&&!1===o._viewer.animationPlaying()){var h=o._viewer._enableSmartLoading;switch(h=void 0!==h?h:lt.SL_ENABLE_ALL){case lt.SL_ENABLE_LOAD:a.loadedLODLevel>r&&(r=a.loadedLODLevel);break;case lt.SL_ENABLE_UNLOAD:a.loadedLODLevel<r&&(r=a.loadedLODLevel);break;case lt.SL_ENABLE_NONE:r=a.loadedLODLevel}}o._updateMeshRequests[s]&&o._updateMeshRequests[s].LODLevel<r&&delete o._updateMeshRequests[s];var m=!1;if(o._viewer.selectedObject.length>0&&a.parents.some(function(e){e.threeNode;return e.threeMeshes[a.id].some(function(e){return!!e.selected})})&&(m=!0),m&&a.loadedLODLevel>r);else if(a.loadedLODLevel!==r||e.forceLoadMaxLOD&&!a.isSegmentLoaded||e.forHighlightLoadMaxLOD&&!a.isSegmentLoaded||!e.forceLoadMaxLOD&&a.isSegmentLoaded){var c=void 0;if(a.bufferView.bufferHD&&a.bufferView.bufferHD){var v=o.getMaxLODLevel(a.modelLODtype);r==v?c=THREE.RANGE_LODTYPE_HD:(c=THREE.RANGE_LODTYPE_LD,a.bufferView.rangeLD&&a.bufferView.rangeLD[0]===a.bufferView.rangeLD[1]&&(r=-1))}o._updateMeshRequests[s]={LODLevel:r,LODtype:c,meshProxy:a,nodeProxy:i,force:e.force,forHighlightLoadMaxLOD:e.forHighlightLoadMaxLOD,forceLoadMinLOD:e.forceLoadMinLOD,forceLoadMaxLOD:e.forceLoadMaxLOD}}if(e.forceLoadMaxLOD&&a.loadedLODLevel===r){var f,E,p=a.primitiveGeometries.length;for(f=0;f<p;f++)(E=a.primitiveGeometries[f])&&(E._onMemoryMaxLOD=!0)}})}},getOutlineFlagFromUnknown:{enumerable:!1,value:function(e){return e!==THREE.OUTFLAG_UNKNOWN?e:this._outlineUnknownLoadMode===this._OUTLINE_LOAD_MODE.OUTLINE?THREE.OUTFLAG_OUTLINE:THREE.OUTFLAG_INSIDE}},postMessage:{enumerable:!1,value:function(e,t){for(var r in this._workers)this._workers[r]&&this._workers[r].postMessage(e,t)}},load:{enumerable:!1,value:function(e,t){var r=0;return function(e,t){var i;if(this._workerType===lt.SL_WORKER_TYPE_MULTIWORKER){if(!t.bufferView)return;if(1===e.LODtype){if(!t.bufferView.bufferLD||!t.bufferView.bufferLD.uri)return;i=this._workers[t.bufferView.bufferLD.uri]}else if(2===e.LODtype){if(!t.bufferView.bufferHD||!t.bufferView.bufferHD.uri)return;i=this._workers[t.bufferView.bufferHD.uri]}else{if(!t.bufferView.buffer||!t.bufferView.buffer.uri)return;i=this._workers[t.bufferView.buffer.uri]}}else i=this._workers[t.id%this._maxWorkerCount];e.id=r,this._workerRequests[r++]={request:e,meshProxy:t},this._workerRequestsCount++,e.forceLoadRequest?this._workerRequestsBuildModel.force.requestCount++:this._workerRequestsBuildModel.smart.requestCount++,i.postMessage(e)}}()},flushLoad:{enumerable:!1,value:function(){this.postMessage({type:"flush"})}},updateGeometry:{enumerable:!1,value:function(e){this._viewer.renderer.updateGeometry(e,!0),this.invalidateViewer()}},_loadTimeoutID:{enumerable:!0,value:void 0,writable:!0},_traverseTable:{enumerable:!0,value:[],writable:!0},clearSegment:{enumerable:!1,value:function(e,t){if(e.isSegmentLoaded){var r,i=e.primitiveGeometries;i.length;e.primitiveGeometries.forEach(function(e){if(e){if(r=e.bufferAttributesOrg){if(t){var i=r.index;if(i){var o=e.getIndex();o.array=i.array,o.itemSize=i.itemSize,o.needsUpdate=!0}}delete e.bufferAttributesOrg}e.segIndices&&delete e.segIndices,e.segGeom&&delete e.segGeom,e.segGeomInfos&&delete e.segGeomInfos}}),delete e.isSegmentLoaded}}},deleteGeometry:{enumerable:!1,value:function(e){var t=e.meshProxy;if(this._viewer.selectedObject.length>0&&t.parents.some(function(e){e.threeNode;return e.threeMeshes[t.id].some(function(e){return!!e.selected})}))return e.LODLevel=0,void this.downGeometryLODLevel(e);t.parents.forEach(function(e){var r=e.threeNode;e.threeMeshes[t.id].forEach(function(e){r.remove(e),e.geometry=null}),e.addTemporaryMesh()}),t.primitiveGeometries.forEach(function(e,r,i){null!==e&&(e.dispose(),i[r]=null,t.primitiveRanges[r].position=null,t.primitiveRanges[r].index=null)}),this.invalidateViewer(!0),t.loadedLODLevel=-1,t.loadedLODType=void 0}},downGeometryLODLevel:{enumerable:!1,value:function(e){function t(e,t,a,s){var n,l,d=o._BUFFER_PARAMETER;if("index"!==a){if(!(n=e.getAttribute(a)))return}else if(!(n=e.getIndex()))return;"index"===a&&s?(l=n.array.subarray(0,t*d.index_32.componentSize),n.array=l,n.itemSize=d.index_32.componentSize):(l=n.array.subarray(0,t*d[a].componentSize),n.array=l,n.itemSize=d[a].componentSize),n.needsUpdate=!0,"index"!==a?(e.removeAttribute(a),"position"===a?n.decodeParam=r:"uv"===a&&(n.decodeParam=i),e.addAttribute(a,n)):e.setIndex(n)}var r,i,o=this,a=e.meshProxy;r=o.getLODDecodeParam(a.boundingBox,e.LODLevel,a.modelLODtype),a.boundingBoxUV&&(i=o.getLODDecodeParam(a.boundingBoxUV,void 0,a.modelLODtype)),a.primitiveGeometries.forEach(function(r,i,s){var n,l=a.primitiveRanges[i],d=a.intIndices[i],u=a.primitiveModes[i];e.LODtype===THREE.RANGE_LODTYPE_LD&&u>>THREE.PRIM_MODE_BIT==1||u>>THREE.PRIM_MODE_BIT==0||(n=l.position[e.LODLevel],t(r,n,"position"),t(r,n,"normal"),t(r,n,"uv"),t(r,n,"color"),t(r,n,"lineDistance"),n=l.index[e.LODLevel],t(r,n,"index",d),l.position=l.position.subarray(0,e.LODLevel+1),l.index=l.index.subarray(0,e.LODLevel+1),o.updateGeometry(r))},this),a.loadedLODLevel=e.LODLevel,a.loadedLODType=e.LODtype}},upGeometryLODLevel:{enumerable:!1,value:function(e){var t=void 0;e.forceLoadMaxLOD&&(t=!0);var r=e.meshProxy,i={type:"load",bufferView:r.bufferView,primitiveModes:r.primitiveModes,intIndices:r.intIndices,loadedLODLevel:r.loadedLODLevel,LODLevel:e.LODLevel,LODtype:e.LODtype,forHighlightLoadMaxLOD:e.forHighlightLoadMaxLOD,forceLoadRequest:t,forceLoadMinLOD:!!e.forceLoadMinLOD||void 0,delayGenGeom:e.delayGenGeom,procAnimObj:e.procAnimObj};(e.forceLoadMaxLOD&&this._isLoadGeometryOffset()||e.forHighlightLoadMaxLOD)&&(i.forceLoadMaxLOD=!0),this.load(i,e.meshProxy)}},processRequests:{enumerable:!1,value:function(){var e=this;e._updateLODLevelTable=[],e._updateLODLevelTableForceLoad=[],e._measureTimeInfo.start(),new Promise(function(t){var r=new THREE.Vector3;e._loadTimeoutID=setTimeout(function(){if(e.execProcRequests(r),e._viewer.loadWholeModel){if(e._stopSmartLoading||(e._smartLoadStart||0===e._updateLODLevelTable.length?e._smartLoadStart&&!e.isStreaming()&&(e._smartLoadStart=!1,e._viewer.dispatchEvent({type:"smartLoadComplete",dataSize:e._totalReceiveDataSize}),e._totalReceiveDataSize=0):(e._smartLoadStart=!0,e._isFirstSmartLoadRequest=!0,e._viewer.dispatchEvent({type:"smartLoadStart"}))),e._isForceLoad())if(e._forceLoadStart||0===e._updateLODLevelTableForceLoad.length){if(e._isForceLoad()&&e._forceLoadStart&&0===Object.keys(e._forceLoadRequests).length&&0===e._updateLODLevelTableForceLoad.length){switch(e._viewer._forceLoadType){case lt.FORCE_LOAD_PROFILE:e._viewer._forceLoadType=void 0}if(!1===e._isForceLoadComplete){if(e._viewer.geomInfo&&e._geomInfoRequests!==e._geomInfoLoaded)return;e._forceLoadStart=!1,e._isForceLoadComplete=!0,e._viewer.dispatchEvent({type:"forceLoadComplete"})}}}else e._forceLoadStart=!0,e._isForceLoadComplete=!1,e._isFirstForceLoadRequest=!0,e._viewer.dispatchEvent({type:"forceLoadStart"}),e.postMessage({type:"set stop force Load",value:!1})}else e._handlecallback(),e._handleForceLoadCallback();t()},e._LOAD_TIME_INTERVAL)}).then(function(){e._updateMeshRequests={},new Promise(function(t){e._loadTimeoutID=setTimeout(function(){var r=function(e,t){return e.z-t.z};e._updateLODLevelTable.sort(r),e._updateLODLevelTableForceLoad.sort(r),t()},e._LOAD_TIME_INTERVAL)}).then(function(){e.execLoad()})})}},execProcRequests:{enumerable:!1,value:function(e,t){for(var r in this._updateMeshRequests){var i=this._updateMeshRequests[r],o=i.meshProxy;t&&Object.assign(i,t);var a=!1,s=!1,n=!1;if(void 0!==i.LODtype?o.loadedLODLevel<i.LODLevel||1===o.loadedLODLevel&&0===i.LODLevel?s=!0:o.loadedLODLevel>i.LODLevel&&-1===i.LODLevel&&(n=!0):(o.loadedLODLevel<i.LODLevel&&(s=!0),o.loadedLODLevel>i.LODLevel&&(n=!0)),s?a=!0:!o.isSegmentLoaded&&o.isSegmentRange()&&(i.forceLoadMaxLOD&&this._isLoadGeometryOffset()?a=!0:i.forHighlightLoadMaxLOD&&(a=!0)),n)i.LODLevel<0?(this.clearSegment(o),this.deleteGeometry(i)):(this.clearSegment(o,!0),this.downGeometryLODLevel(i));else if(a){var l=i.nodeProxy.temporaryMesh;e.setFromMatrixPosition(l.matrixWorld),e.applyProjection(this._projScreenMatrix),i.z=e.z,i.forceLoadMaxLOD?this._updateLODLevelTableForceLoad.push(i):this._updateLODLevelTable.push(i),i.forceLoadMaxLOD&&(this._forceLoadRequests[r]={meshId:o.id,primitiveCount:o.primitiveGeometries.length})}else i.forHighlightLoadMaxLOD&&o.isSegmentLoaded||!i.forceLoadMaxLOD&&o.isSegmentLoaded&&this.clearSegment(o,!0)}}},execLoad:{enumerable:!1,value:function(){var e=this,t=function(){for(var r,i=e._EXEC_LOAD_COUNT,o=0;(r=e._updateLODLevelTable.shift())&&(e.upGeometryLODLevel(r),!(++o>=i)););for(;(r=e._updateLODLevelTableForceLoad.shift())&&(e.upGeometryLODLevel(r),!(++o>=i)););e.flushLoad(),0!==e._updateLODLevelTable.length||0!==e._updateLODLevelTableForceLoad.length?e._loadTimeoutID=setTimeout(t,e._LOAD_TIME_INTERVAL):e._loadTimeoutID=void 0};t()}},hasLoadRequests:{enumerable:!1,value:function(e){return e?this._updateLODLevelTableForceLoad.length>0:this._updateLODLevelTable.length>0}},clearUpdateMeshRequests:{enumerable:!1,value:function(){this._loadTimeoutID&&clearTimeout(this._loadTimeoutID);var e=this._updateMeshRequests;Object.keys(e).forEach(function(t){e[t].force||delete e[t]})}},clearLoadBatchCount:{enumerable:!1,value:function(){this._workerRequestsCount=0,this._workerRequestsLoadedCount=0}},clearInstanceMaxLODLevels:{enumerable:!1,value:function(){var e=this._instanceMaxLODLevels;Object.keys(e).forEach(function(t){delete e[t]})}},has2StepLODInfo:{enumerable:!1,value:function(e){var t=!1;return e&&e.meshProxies?(e.meshProxies.some(function(e){if(e&&e.bufferView)return e.bufferView.bufferHD&&e.bufferView.bufferHD?(t=!0,!0):void 0}),t):t}},terminate:{enumerable:!1,value:function(){if(this._temporaryGeometry){this._temporaryGeometry.dispose(),this._temporaryGeometry=null,this._workers.forEach(function(e){e.terminate()});for(var e in this._workers)this._workers[e].terminate();this._workers.length=0,this._workers=[],this._gemetryMemoryInfo=0,THREE.enableStreaming=!1}}},getLODDecodeParam:{enumerable:!1,value:function(e,t,r){var i,o=e.max.length,a=[],s=[],n=1,l={};for(3===o&&void 0!==t&&(n=void 0!==r&&r===THREE.LODTYPE_2?this._decodeFactors.LODTYPE_2[t]:this._decodeFactors.LODTYPE_16[t],l.factor=n),i=0;i<o;i++)a[i]=(e.max[i]-e.min[i])*n/(THREE.USHRT_MAX-n+1),s[i]=e.min[i];return l.scale=a,l.trans=s,l}},getStopSmartLoading:{enumerable:!1,value:function(){return!!this._stopSmartLoading}},setStopSmartLoading:{enumerable:!1,value:function(e,t){if(e){if(this._stopSmartLoading&&!t)return;this._stopSmartLoading=!0,this.clearUpdateMeshRequests(),this.clearInstanceMaxLODLevels(),this.postMessage({type:"interrupt"})}else{if(!this._stopSmartLoading)return;this._stopSmartLoading=!1}}},clearForceLoadRequests:{enumerable:!1,value:function(){this._forceLoadStart&&Object.keys(this._forceLoadRequests).length>0?this.postMessage({type:"set stop force Load",value:!0}):this._forceLoadRequests={}}},delayGenerateGeometry:{enumerable:!1,value:function(){for(var e;e=this._delayGenGeomTable.shift();)this._generateGeometry(e.response,e.request)}},isStreaming:{enumerable:!1,value:function(){var e=!0,t=Object.keys(this._workerRequests),r=t.length;if(0===r&&0===this._updateLODLevelTable.length)e=!1;else if(this._updateLODLevelTable.length>0)e=!0;else{var i,o,a,s=!1;for(i=0;i<r;i++){if(o=t[i],a=this._workerRequests[o].request,void 0===a.forceLoadRequest){s=!0;break}if(!0===a.procAnimObj){s=!0;break}}e=!!s}return e}},isForceStreaming:{enumerable:!1,value:function(){if(this._isForceLoad()){var e=!0;return 0===Object.keys(this._forceLoadRequests).length&&0===this._updateLODLevelTableForceLoad.length&&!0===this._isForceLoadComplete&&(e=!1),e}return!1}},setStreamLoadOption:{enumerable:!1,value:function(e){this._streamLoadOption=e}},getStreamLoadOption:{enumerable:!1,value:function(){return this._streamLoadOption?this._streamLoadOption:lt.SL_OPTION_NONE}},_isForceLoad:{enumerable:!1,value:function(){return void 0!==this._viewer._forceLoadType||!0===this._viewer.loadWholeModel}},_isLoadWholeModel:{enumerable:!1,value:function(){return this._viewer._forceLoadType===lt.FORCE_LOAD_ALL||!0===this._viewer.loadWholeModel}},_isLoadSegmentData:{enumerable:!1,value:function(){return this._viewer.loadWholeModel&&this._viewer.loadWholeModelElemSelect||!0===this._viewer._forceLoadOptSegment}},_isLoadGeometryOffset:{enumerable:!1,value:function(){var e=this._viewer.loadWholeModel&&this._viewer.loadWholeModelElemSelect&&this._viewer.loadWholeModelElemMeasure,t=!0===this._viewer._forceLoadOptSegment&&!0===this._viewer._forceLoadOptGeometry;return e||t}},_clearTemporaryMeshSelected:{enumerable:!1,value:function(){for(var e in this._updateTemporaryMeshSelected){var t=this._updateTemporaryMeshSelected[e];void 0!==t.selected&&delete t.selected}this._updateTemporaryMeshSelected={}}},isAllExecutionRequestsCompleted:{enumerable:!1,value:function(){return 0===Object.keys(this._updateMeshRequests).length&&0===this._updateLODLevelTable.length&&0===this._updateLODLevelTableForceLoad.length&&0===Object.keys(this._workerRequests).length}},updateModelProgress:{enumerable:!1,value:function(){if(this._viewer&&this._viewer._buildModelProgressCallback){var e=0,t=0;this._workerRequestsBuildModel.smart.requestCount>0&&t++,this._workerRequestsBuildModel.force.requestCount>0&&t++,this._viewer.geomInfo&&this._geomInfoRequests>0&&t++;var r=80/t;this._workerRequestsBuildModel.smart.requestCount>0&&(e+=this._workerRequestsBuildModel.smart.execedCount/this._workerRequestsBuildModel.smart.requestCount*r),this._workerRequestsBuildModel.force.requestCount>0&&(e+=this._workerRequestsBuildModel.force.execedCount/this._workerRequestsBuildModel.force.requestCount*r),this._geomInfoRequests>0&&(e+=this._geomInfoLoaded/this._geomInfoRequests*r),this._viewer._buildModelProgressCallback({Progress:e})}}}})},function(){THREE.streamManager||(THREE.enableStreaming=!0,THREE.StreamManager=function(){var e={},t=null;this.getStream=function(t,r){if(void 0!==e[t.uuid])return e[t.uuid];if(!r)return null;var i=new THREE.Stream;return e[t.uuid]=i,i},this.terminateStream=function(r){for(var i in e)e[i]===r&&(e[i].terminate(),t===e[i]&&(t=null),delete e[i])},this.setCurrentStream=function(e){t=e},this.getCurrentStream=function(){return t}},THREE.streamManager=new THREE.StreamManager)}();